<!DOCTYPE html>
<html>
<head>
  <title>TransAT1000</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.4.0/gpx.min.js"></script>
  <style>
    body { margin: 0; }
    #map { height: 90vh; }
    h2 { text-align: center; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>TransAT 1000</h2>
  <div id="map"></div>

  <script>
// Kartenlayer definieren
    var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap-Mitwirkende'
    });

    var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles © Esri'
    });

// Karte initialisieren
    var map = L.map('map', {
      center: [47.44, 13.88],
      zoom: 8,
      layers: [osm]
    });

    // Layer-Control hinzufügen
    var baseMaps = {
      "Karte (OSM)": osm,
      "Satellit (Esri)": satellite
    };
    L.control.layers(baseMaps).addTo(map);

// GPX-Track laden
new L.GPX("AT_West_East.gpx", {
  async: true,
  marker_options: {
    startIconUrl: null,
    endIconUrl: null,
    shadowUrl: null
  }
}).on('loaded', function(e) {
  map.fitBounds(e.target.getBounds());

  const line = e.target.getLayers()[0];
  const latlngs = line.getLatLngs();

  let distance = 0;
  let nextKm = 50; // alle 50 km statt 10

  // Startmarkierung bei 0 km
  L.circleMarker(latlngs[0], {
    radius: 4,
    color: 'green',
    fillColor: 'green',
    fillOpacity: 1
  }).addTo(map)
    .bindPopup("0 km")
    .bindTooltip("0 km", { permanent: true, direction: 'right', offset: [6, 0] });

  for (let i = 1; i < latlngs.length; i++) {
    const segDist = latlngs[i - 1].distanceTo(latlngs[i]) / 1000;
    distance += segDist;

    if (distance >= nextKm) {
      L.circleMarker(latlngs[i], {
        radius: 4,
        color: '#333',
        fillColor: '#007bff',
        fillOpacity: 0.8
      }).addTo(map)
        .bindPopup(`${nextKm} km`)
        .bindTooltip(`${nextKm} km`, { permanent: true, direction: 'right', offset: [6, 0] });

      nextKm += 50;
    }
  }

  // Endmarkierung (hier weiterhin "1000 km")
  const last = latlngs[latlngs.length - 1];
  L.circleMarker(last, {
    radius: 4,
    color: 'red',
    fillColor: 'red',
    fillOpacity: 1
  }).addTo(map)
    .bindPopup("1000 km")
    .bindTooltip("1000 km", { permanent: true, direction: 'right', offset: [6, 0] });
}).addTo(map);



    // Live-Marker
    var marker = L.marker([0, 0]).addTo(map).bindPopup("Live");

    // Liveposition aktualisieren
    async function updatePosition() {
      try {
        const res = await fetch("https://MEIN-TRACCAR.onrender.com/api/positions", {
          headers: {
            "Authorization": "Basic " + btoa("DEIN_USER:DEIN_PASS")
          }
        });
        const data = await res.json();
        const pos = data.find(p => p.deviceId === DEINE_DEVICE_ID);
        if (pos) {
          marker.setLatLng([pos.latitude, pos.longitude]);
        }
      } catch (err) {
        console.error("Fehler bei Positionsabfrage", err);
      }
    }

    setInterval(updatePosition, 10000);
  </script>
</body>
</html>
